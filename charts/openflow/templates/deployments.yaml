{{- $domain := print (required "domain required!" .Values.domain) "." (required "domainsuffix required!" .Values.domainsuffix) }}
{{- $apidomain := $domain }}
{{- if .Values.apidomain }}
  {{- $apidomain = print .Values.apidomain "." (required "domainsuffix required!" .Values.domainsuffix) }}
{{- end }}
{{- $apiuri := print .Values.protocol "://" $apidomain }}
{{- if .Values.port }}
  {{- $dummy := set . "apiuri" .Values.protocol ":" .Values.port "://" $apidomain }}
{{- end }}
# ":4317"
{{- $oteluri := print .Values.protocol "://otel." $apidomain }}
{{- if .Values.port }}
  {{- $oteluri := print .Values.protocol "://otel." $apidomain ":" .Values.port }}
{{- end }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api
spec:
  replicas: {{ .Values.openflow.replicas }}
  selector:
    matchLabels:
      role: api
  strategy:
    type: {{ required "A valid .Values.openflow.deploymentstrategy entry required!" .Values.openflow.deploymentstrategy }}
  template:
    metadata:
      labels:
        role: api
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: {{ .Values.openflow.port | quote }}
    spec:
      serviceAccountName: openflow-api-user
      {{- if .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml .Values.nodeSelector | nindent 12 }}
      {{- else if .Values.openflow.nodeSelector }}
      nodeSelector:
        {{- toYaml .Values.openflow.nodeSelector | nindent 12 }}
      {{- end }}
      {{- if .Values.openflow.topologySpreadConstraints }}
      topologySpreadConstraints:
        {{- toYaml .Values.openflow.topologySpreadConstraints | nindent 12 }}
      {{- end }}
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets: {{ .Values.imagePullSecrets | quote }}
      {{- end }}      
      terminationGracePeriodSeconds: {{ .Values.openflow.terminationGracePeriodSeconds  }}
      containers:
        - name: api
          image: {{ default "openiap/openflow" .Values.openflow.image | quote }}
      {{- if .Values.openflow.prestop.enabled }}
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh","-c", {{ .Values.openflow.prestop.command | quote }}]
      {{- end }}
          imagePullPolicy: Always
          resources:
            {{- toYaml .Values.openflow.resources | nindent 12 }}
          ports:
            - containerPort: {{ .Values.openflow.port }}
            - containerPort: 5858
{{- if .Values.openflow.livenessProbe.enabled }}
          livenessProbe:
            httpGet:
              path: {{ .Values.openflow.livenessProbe.path }}
              port: {{ .Values.openflow.port }}
              scheme: HTTP
            initialDelaySeconds: {{ .Values.openflow.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.openflow.livenessProbe.periodSeconds }}
            failureThreshold: {{ .Values.openflow.livenessProbe.failureThreshold }}
            timeoutSeconds: {{ .Values.openflow.livenessProbe.timeoutSeconds }}
{{- end }}
{{- if .Values.openflow.readinessProbe.enabled }}
          readinessProbe:
            httpGet:
              path: {{ .Values.openflow.readinessProbe.path }}
              port: {{ .Values.openflow.port }}
              scheme: HTTP
            initialDelaySeconds: {{ .Values.openflow.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.openflow.readinessProbe.periodSeconds }}
            failureThreshold: {{ .Values.openflow.readinessProbe.failureThreshold }}
            timeoutSeconds: {{ .Values.openflow.readinessProbe.timeoutSeconds }}
{{- end }}
{{- if .Values.openflow.startupProbe.enabled }}
          startupProbe:
            httpGet:
              path: {{ .Values.openflow.startupProbe.path }}
              port: {{ .Values.openflow.port }}
              scheme: HTTP
            initialDelaySeconds: {{ .Values.openflow.startupProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.openflow.startupProbe.periodSeconds }}
            failureThreshold: {{ .Values.openflow.startupProbe.failureThreshold }}
            timeoutSeconds: {{ .Values.openflow.startupProbe.timeoutSeconds }}
{{- end }}
          env:
            - name: heapdump_onstop
              value: {{ .Values.openflow.heapdump_onstop | quote }}
            - name: getting_started_url
              value: {{ .Values.openflow.getting_started_url | quote }}
            - name: otel_trace_dashboardauth
              value: {{ .Values.openflow.otel_trace_dashboardauth | quote }}
            - name: otel_trace_pingclients
              value: {{ .Values.openflow.otel_trace_pingclients | quote }}
            - name: otel_trace_include_query
              value: {{ .Values.openflow.otel_trace_include_query | quote }}
            - name: otel_trace_connection_ips
              value: {{ .Values.openflow.otel_trace_connection_ips | quote }}
            - name: otel_trace_mongodb_per_users
              value: {{ .Values.openflow.otel_trace_mongodb_per_users | quote }}
            - name: otel_trace_mongodb_query_per_users
              value: {{ .Values.openflow.otel_trace_mongodb_query_per_users | quote }}
            - name: otel_trace_mongodb_aggregate_per_users
              value: {{ .Values.openflow.otel_trace_mongodb_aggregate_per_users | quote }}
            - name: otel_trace_mongodb_insert_per_users
              value: {{ .Values.openflow.otel_trace_mongodb_insert_per_users | quote }}
            - name: otel_trace_mongodb_update_per_users
              value: {{ .Values.openflow.otel_trace_mongodb_update_per_users | quote }}
            - name: otel_trace_mongodb_delete_per_users
              value: {{ .Values.openflow.otel_trace_mongodb_delete_per_users | quote }}
            - name: socket_rate_limit
              value: {{ .Values.openflow.socket_rate_limit | quote }}
            - name: socket_rate_limit_points
              value: {{ .Values.openflow.socket_rate_limit_points | quote }}
            - name: socket_rate_limit_duration
              value: {{ .Values.openflow.socket_rate_limit_duration | quote }}
            - name: socket_rate_limit_points_disconnect
              value: {{ .Values.openflow.socket_rate_limit_points_disconnect | quote }}
            - name: client_heartbeat_timeout
              value: {{ .Values.openflow.client_heartbeat_timeout | quote }}
            - name: client_signin_timeout
              value: {{ .Values.openflow.client_signin_timeout | quote }}
            - name: api_rate_limit
              value: {{ .Values.openflow.api_rate_limit | quote }}
            - name: api_rate_limit_points
              value: {{ .Values.openflow.api_rate_limit_points | quote }}
            - name: api_rate_limit_duration
              value: {{ .Values.openflow.api_rate_limit_duration | quote }}
            - name: supports_watch
              value: {{ .Values.openflow.supports_watch | quote }}
            - name: log_with_colors
              value: {{ .Values.openflow.log_with_colors | quote }}
            - name: log_cache
              value: {{ .Values.openflow.log_cache | quote }}
            - name: log_amqp
              value: {{ .Values.openflow.log_amqp | quote }}
            - name: log_login_provider
              value: {{ .Values.openflow.log_login_provider | quote }}
            - name: log_websocket
              value: {{ .Values.openflow.log_websocket | quote }}
            - name: log_oauth
              value: {{ .Values.openflow.log_oauth | quote }}
            - name: log_webserver
              value: {{ .Values.openflow.log_webserver | quote }}
            - name: log_database
              value: {{ .Values.openflow.log_database | quote }}
            - name: log_grafana
              value: {{ .Values.openflow.log_grafana | quote }}
            - name: log_housekeeping
              value: {{ .Values.openflow.log_housekeeping | quote }}
            - name: log_otel
              value: {{ .Values.openflow.log_otel | quote }}
            - name: log_blocked_ips
              value: {{ .Values.openflow.log_blocked_ips | quote }}
            - name: log_information
              value: {{ .Values.openflow.log_information | quote }}
            - name: log_debug
              value: {{ .Values.openflow.log_debug | quote }}
            - name: log_verbose
              value: {{ .Values.openflow.log_verbose | quote }}
            - name: log_silly
              value: {{ .Values.openflow.log_silly | quote }}
            - name: log_to_exchange
              value: {{ .Values.openflow.log_to_exchange | quote }}
            - name: validate_emails
              value: {{ .Values.openflow.validate_emails | quote }}
            - name: forgot_pass_emails
              value: {{ .Values.openflow.forgot_pass_emails | quote }}
            - name: debounce_lookup
              value: {{ .Values.openflow.debounce_lookup | quote }}
            - name: validate_emails_disposable
              value: {{ .Values.openflow.validate_emails_disposable | quote }}
            - name: smtp_service
              value: {{ .Values.openflow.smtp_service | quote }}
            - name: smtp_from
              value: {{ .Values.openflow.smtp_from | quote }}
            - name: smtp_user
              value: {{ .Values.openflow.smtp_user | quote }}
            - name: smtp_pass
              value: {{ .Values.openflow.smtp_pass | quote }}
            - name: smtp_url
              value: {{ .Values.openflow.smtp_url | quote }}
            - name: amqp_allow_replyto_empty_queuename
              value: {{ .Values.openflow.amqp_allow_replyto_empty_queuename | quote }}
            - name: ensure_indexes
              value: {{ .Values.openflow.ensure_indexes | quote }}
            - name: enable_openflow_amqp
              value: {{ .Values.openflow.enable_openflow_amqp | quote }}
            - name: openflow_amqp_expiration
              value: {{ .Values.openflow.openflow_amqp_expiration | quote }}
            - name: amqp_prefetch
              value: {{ .Values.openflow.amqp_prefetch | quote }}
            - name: enable_entity_restriction
              value: {{ .Values.openflow.enable_entity_restriction | quote }}
            - name: enable_web_tours
              value: {{ .Values.openflow.enable_web_tours | quote }}
            - name: enable_nodered_tours
              value: {{ .Values.openflow.enable_nodered_tours | quote }}
            - name: ping_clients_interval
              value: {{ .Values.openflow.ping_clients_interval | quote }}
            - name: license_key
              value: {{ default "" .Values.openflow.license_key | quote }}
            - name: stripe_api_key
              value: {{ default "" .Values.openflow.stripe_api_key | quote }}
            - name: stripe_api_secret
              value: {{ default "" .Values.openflow.stripe_api_secret | quote }}
            - name: NODE_ENV
              value: {{ default "" .Values.NODE_ENV | quote }}
            - name: nodered_initial_liveness_delay
              value: {{ .Values.openflow.nodered_initial_liveness_delay | quote }}
            - name: multi_tenant
              value: {{ .Values.openflow.multi_tenant | quote }}
            - name: update_acl_based_on_groups
              value: {{ .Values.openflow.update_acl_based_on_groups | quote }}
            - name: oidc_access_token_ttl
              value: {{ .Values.openflow.oidc_access_token_ttl | quote }}
            - name: oidc_authorization_code_ttl
              value: {{ .Values.openflow.oidc_authorization_code_ttl | quote }}
            - name: oidc_client_credentials_ttl
              value: {{ .Values.openflow.oidc_client_credentials_ttl | quote }}
            - name: oidc_refresh_token_ttl
              value: {{ .Values.openflow.oidc_refresh_token_ttl | quote }}
            - name: oidc_session_ttl
              value: {{ .Values.openflow.oidc_session_ttl | quote }}
            - name: websocket_package_size
              value: {{ .Values.openflow.websocket_package_size | quote }}
            - name: websocket_max_package_count
              value: {{ .Values.openflow.websocket_max_package_count | quote }}
            - name: nodered_images
              value: {{ .Values.openflow.nodered_images | quote }}
            - name: amqp_force_queue_prefix
              value: {{ .Values.openflow.amqp_force_queue_prefix | quote }}
            - name: amqp_force_exchange_prefix
              value: {{ .Values.openflow.amqp_force_exchange_prefix | quote }}
            - name: amqp_force_sender_has_read
              value: {{ .Values.openflow.amqp_force_sender_has_read | quote }}
            - name: amqp_force_sender_has_invoke
              value: {{ .Values.openflow.amqp_force_sender_has_invoke | quote }}
            - name: amqp_force_consumer_has_update
              value: {{ .Values.openflow.amqp_force_consumer_has_update | quote }}
            - name: amqp_enabled_exchange
              value: {{ .Values.openflow.amqp_enabled_exchange | quote }}
            - name: upload_max_filesize_mb
              value: {{ .Values.openflow.upload_max_filesize_mb | quote }}
            - name: use_ingress_beta1_syntax
              value: {{ .Values.openflow.use_ingress_beta1_syntax | quote }}
            - name: namespace
              value: {{ .Release.Namespace | quote }}
            - name: allow_personal_nodered
              value: {{ .Values.openflow.allow_personal_nodered | quote }}
            - name: auto_create_personal_nodered_group
              value: {{ .Values.openflow.auto_create_personal_nodered_group | quote }}
            - name: auto_create_personal_noderedapi_group
              value: {{ .Values.openflow.auto_create_personal_noderedapi_group | quote }}              
            - name: nodered_domain_schema
              value: "$nodered_id$.{{ $domain }}"
            - name: protocol
              value: {{ .Values.protocol | quote }}
            - name: port
              value: {{ .Values.openflow.port | quote }}
            - name: skip_history_collections
              value: {{ .Values.openflow.skip_history_collections | quote }}
            - name: tls_passphrase
              value: {{ default "" .Values.openflow.tls_passphrase | quote }}
            - name: auto_create_users
              value: {{ .Values.openflow.auto_create_users | quote }}
            - name: auto_create_domains
              value: {{ default "" .Values.openflow.auto_create_domains | quote }}
            - name: persist_user_impersonation
              value: {{ .Values.openflow.persist_user_impersonation | quote }}
            - name: aes_secret
              value: {{ .Values.openflow.aes_secret | quote }}
            - name: tls_crt
              value: {{ default "" .Values.openflow.tls_crt | quote }}
            - name: tls_key
              value: {{ default "" .Values.openflow.tls_key | quote }}
            - name: tls_ca
              value: {{ default "" .Values.openflow.tls_ca | quote }}
            - name: signing_crt
              value: {{ .Values.openflow.signing_crt | quote }}
            - name: singing_key
              value: {{ .Values.openflow.singing_key | quote }}
            - name: saml_federation_metadata
{{- if .Values.openflow.saml_federation_metadata }}
              value: {{ .Values.openflow.saml_federation_metadata | quote }}
{{- else }}
              value: "{{ $apiuri }}/issue/FederationMetadata/2007-06/FederationMetadata.xml"
{{- end }}
            - name: saml_issuer
              value: "uri:{{ $apidomain }}"
{{- if .Values.openflow.external_mongodb_url }}
            - name: mongodb_url
              value: {{ .Values.openflow.external_mongodb_url | quote }}
            - name: mongodb_db
              value: {{ .Values.openflow.mongodb_db | quote }}
{{- else }}
            - name: mongodb_url
              value: {{ include "mongodburl" . | quote }}
  {{- if .Values.mongodb.auth.initdb }}
            - name: mongodb_db
              value: {{ .Values.mongodb.auth.initdb | quote }}
  {{- else if .Values.openflow.mongodb_db }}
            - name: mongodb_db
              value: {{ .Values.openflow.mongodb_db | quote }}
  {{- else }}
            - name: mongodb_db
              value: {{ .Release.Namespace | quote }}
  {{- end }}
{{- end }}
            - name: mongodb_minpoolsize
              value: {{ .Values.openflow.mongodb_minpoolsize | quote }}
            - name: mongodb_maxpoolsize
              value: {{ .Values.openflow.mongodb_maxpoolsize | quote }}
            - name: amqp_url
              value: "amqp://{{ .Values.rabbitmq.default_user }}:{{ .Values.rabbitmq.default_pass }}@rabbitmq"
            - name: api_ws_url
              value: {{ .Values.openflow.api_ws_url | quote }}
            - name: nodered_ws_url
              value: {{ .Values.openflow.nodered_ws_url | quote }}
            - name: nodered_saml_entrypoint
              value: {{ .Values.openflow.nodered_saml_entrypoint | quote }}
            - name: domain
              value: "{{ $apidomain }}"
            - name: nodered_allow_nodeselector
              value: {{ .Values.openflow.nodered_allow_nodeselector | quote }}
            - name: nodered_requests_memory
              value: {{ .Values.openflow.nodered_requests_memory | quote }}
            - name: nodered_requests_cpu
              value: {{ .Values.openflow.nodered_requests_cpu | quote }}
            - name: nodered_limits_memory
              value: {{ .Values.openflow.nodered_limits_memory | quote }}
            - name: nodered_limits_cpu
              value: {{ .Values.openflow.nodered_limits_cpu | quote }}
            - name: nodered_liveness_failurethreshold
              value: {{ .Values.openflow.nodered_liveness_failurethreshold | quote }}
            - name: nodered_liveness_timeoutseconds
              value: {{ .Values.openflow.nodered_liveness_timeoutseconds | quote }}
            - name: noderedcatalogues
              value: {{ .Values.openflow.noderedcatalogues | quote }}
            - name: otel_measure_nodeid
              value: {{ .Values.openflow.otel_measure_nodeid | quote }}
            - name: otel_measure_queued_messages
              value: {{ .Values.openflow.otel_measure_queued_messages | quote }}
            - name: otel_measure_mongodb_watch
              value: {{ .Values.openflow.otel_measure_mongodb_watch | quote }}
            - name: otel_measure_onlineuser
              value: {{ .Values.openflow.otel_measure_onlineuser | quote }}
            - name: enable_analytics
              value: {{ .Values.openflow.enable_analytics | quote }}
            - name: cache_store_type
              value: {{ .Values.openflow.cache_store_type | quote }}
            - name: cache_store_redis_host
              value: {{ .Values.openflow.cache_store_redis_host | quote }}
            - name: cache_store_redis_password
              value: {{ .Values.openflow.cache_store_redis_password | quote }}
            - name: cache_store_ttl_seconds
              value: {{ .Values.openflow.cache_store_ttl_seconds | quote }}
            - name: cache_store_max
              value: {{ .Values.openflow.cache_store_max | quote }}
{{- if .Values.openflow.otel_trace_url }}
            - name: otel_trace_url
              value: {{ .Values.openflow.otel_trace_url | quote }}
{{- else }}
  {{- if or (eq .Values.jaeger.enabled true) (eq .Values.zipkin.enabled true) }}
    {{- if (eq .Values.exporter.exposed true) }}
            - name: otel_trace_url
              value: "{{ $oteluri }}/v1/trace"
    {{- else }}
            - name: otel_trace_url
              value: "http://otel-collector:4317/v1/trace"
    {{- end }}
  {{- end }}
{{- end }}
{{- if .Values.openflow.otel_metric_url }}
            - name: otel_metric_url
              value: {{ .Values.openflow.otel_metric_url | quote }}
{{- else }}

  {{- if or (eq (index .Values "victoria-metrics-cluster" "enabled") true) (eq .Values.victoriametrics.enabled true) }}
    {{- if (eq .Values.exporter.exposed true) }}
            - name: otel_metric_url
              value: "{{ $oteluri }}/v1/metrics"
    {{- else }}
            - name: otel_metric_url
              value: "http://otel-collector:4317/v1/metrics"
    {{- end }}
  {{- end }}



{{- end }}
            - name: otel_debug_log
              value: {{ .Values.openflow.otel_debug_log | quote }}
            - name: otel_servicename
              value: {{ .Values.openflow.otel_servicename | quote }}
            - name: otel_trace_interval
              value: {{ .Values.openflow.otel_trace_interval | quote }}
            - name: otel_metric_interval
              value: {{ .Values.openflow.otel_metric_interval | quote }}
            - name: expected_max_roles
              value: {{ .Values.openflow.expected_max_roles | quote }}
            - name: max_recursive_group_depth
              value: {{ .Values.openflow.max_recursive_group_depth | quote }}              
            - name: decorate_roles_fetching_all_roles
              value: {{ .Values.openflow.decorate_roles_fetching_all_roles | quote }}              
            - name: roles_cached_in_seconds
              value: {{ .Values.openflow.roles_cached_in_seconds | quote }}              
            - name: validate_user_form
              value: {{ .Values.openflow.validate_user_form | quote }}              
            - name: auto_hourly_housekeeping
              value: {{ .Values.openflow.auto_hourly_housekeeping | quote }}              
            - name: housekeeping_update_usage_hourly
              value: {{ .Values.openflow.housekeeping_update_usage_hourly | quote }}              
            - name: housekeeping_update_usersize_hourly
              value: {{ .Values.openflow.housekeeping_update_usersize_hourly | quote }}              
            - name: housekeeping_skip_collections
              value: {{ .Values.openflow.housekeeping_skip_collections | quote }}              
            - name: workitem_queue_monitoring_enabled
              value: {{ .Values.openflow.workitem_queue_monitoring_enabled | quote }}              
            - name: workitem_queue_monitoring_interval
              value: {{ .Values.openflow.workitem_queue_monitoring_interval | quote }}              
            - name: stripe_force_vat
              value: {{ .Values.openflow.stripe_force_vat | quote }}              
            - name: stripe_force_checkout
              value: {{ .Values.openflow.stripe_force_checkout | quote }}              
            - name: DEBUG
              value: {{ .Values.openflow.debug | quote }}              
            - name: HTTP_PROXY
              value: {{ .Values.openflow.HTTP_PROXY | quote }}              
            - name: HTTPS_PROXY
              value: {{ .Values.openflow.HTTPS_PROXY | quote }}              
            - name: NO_PROXY
              value: {{ .Values.openflow.NO_PROXY | quote }}              
            - name: shorttoken_expires_in
              value: {{ .Values.openflow.shorttoken_expires_in | quote }}              
            - name: longtoken_expires_in
              value: {{ .Values.openflow.longtoken_expires_in | quote }}              
            - name: downloadtoken_expires_in
              value: {{ .Values.openflow.downloadtoken_expires_in | quote }}              
            - name: personalnoderedtoken_expires_in
              value: {{ .Values.openflow.personalnoderedtoken_expires_in | quote }}              
            - name: wapid_pub
              value: {{ .Values.openflow.wapid_pub | quote }}              
            - name: wapid_key
              value: {{ .Values.openflow.wapid_key | quote }}              
            - name: wapid_mail
              value: {{ .Values.openflow.wapid_mail | quote }}              
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rabbitmq
spec:
  replicas: 1
  selector:
    matchLabels:
      role: rabbitmq
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        role: rabbitmq
        environment: production
    spec:
      {{- if .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml .Values.nodeSelector | nindent 8 }}
      {{- end }}
      {{- if .Values.imagePullSecrets }}
      imagePullSecrets: {{ .Values.imagePullSecrets | quote }}
      {{- end }}      
      containers:
        - name: rabbitmq
          image: {{ .Values.rabbitmq.image | quote }}
          resources:
            {{- toYaml .Values.rabbitmq.resources | nindent 12 }}
          ports:
            - containerPort: 5672
              name: rabbitmq
            - containerPort: 15672
              name: rabbitmq-mgnt
          env:
          {{- if .Values.rabbitmq.vm_memory_high_watermark }}
            - name: RABBITMQ_VM_MEMORY_HIGH_WATERMARK
              value: {{ .Values.rabbitmq.vm_memory_high_watermark }}
          {{- end }}
            - name: RABBITMQ_DEFAULT_USER
              value: {{ required "A valid .Values.rabbitmq.default_user entry required!" .Values.rabbitmq.default_user }}
            - name: RABBITMQ_DEFAULT_PASS
              value: {{ required "A valid .Values.rabbitmq.default_pass entry required!" .Values.rabbitmq.default_pass }}
